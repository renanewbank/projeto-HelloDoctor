<!doctype html>

<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>HelloDoctor — Agenda (Semana)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" href="./images/ClipboardCheck.png" type="image/x-icon">
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .week-toolbar { display:flex; justify-content:space-between; align-items:center; margin-top:40px; margin-bottom:18px; }
    .calendar-wrap { display:flex; gap:18px; }
    .week-card { background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; width:100%; box-shadow:var(--shadow); }

    /* grid: left column times, then 7 day columns */
    .week-grid {
      display:grid;
      grid-template-columns: 80px repeat(7, 1fr);
      gap:0;
      position:relative;
      height: calc(40px * 22);
      border:1px solid var(--border);
    }
    .time-column {
      background:linear-gradient(#fff,#fff);
      border-right:1px solid var(--border);
    }
    .time-slot {
      height:40px; /* slot height: 30min per slot -> adjust if you change generateHours */
      padding:6px 8px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px dashed var(--border);
    }
    .day-col {
      position:relative;
      border-right:1px solid var(--border);
    }
    .day-col:last-child {
      border-right:none;
    }
    .day-col .day-head {
      height:40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px;
      border-bottom:1px solid var(--border);
      background-color:#e6f0f9;
      font-weight:600;
      color:#0b3a67; 
      text-align:center;
      text-transform: uppercase;
    }

    /* appointment box absolute positioned inside day-col */
    .appt {
      position:absolute;
      left:6px;
      right:6px;
      padding: 4px 8px;
      background:#e6f0ff;
      border-radius:8px;
      box-shadow:0 1px 0 rgba(0,0,0,0.04);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:4px;
      border:1px solid rgba(11,58,103,0.08);
    }
    .appt .who { font-size:13px; font-weight:600; color:#0b3a67; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .appt .meta { font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:8px; margin-top: -5px; }

    
    /* Autocomplete list basic */
    .ac-list { position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff; border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow); z-index:40; max-height:220px; overflow:auto; display:none; }
    .ac-item { padding:10px; cursor:pointer; }
    .ac-item:hover { background:#f1f5f9; }
    .ac-empty { padding:10px; color:var(--muted); cursor:pointer; }
    /* small style for Agendar button shown on empty rows */
    .btn-slot { display:none; }
    tr[data-empty="true"]:hover .btn-slot { display:inline-block; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo"><img src="./images/ClipboardCheck.png" alt=""><h1>HelloDoctor</h1></div>
  
    <nav class="topnav">
      <a href="/agenda-day.html" class="active">Agenda</a>
      <a href="/patients.html">Prontuários</a>
      <a href="/insurances.html">Convênios</a>
    </nav>
    <div class="topbar__right">
      <span class="badge float todayBadge"></span>
      <div style="width:28px;height:28px;border-radius:999px;background:#e2e8f0;"></div>
    </div>
  </header>

  <div class="main-layout">
    <aside class="sidebar">
      <span class="badge todayBadge"></span>
      <div class="sidebar-title">Pacientes do dia</div>
      <div id="asideList"></div>
    </aside>

    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; margin-bottom:24px;">
        <h2>Agenda da
          <span>Dra. Maria Ligia Pereira <img style="cursor: pointer;" src="./images/ChevronDownVector.png" alt=""></span>
        </h2>
        <button id="openModalBtn" class="btn-primary btn-icon"><img src="./images/AddVector.png" alt=""> Nova Consulta</button>
      </div>

      <div class="card">
        <div class="header-actions">
          <div style="display: flex; gap:12px; margin-left: -12px;">
            <button id="todayWeek" class="btn-secondary" style="margin-left:12px; border: 2px solid var(--border);">Hoje</button>
            <div class="pager__label">
              <button id="prevWeek" class="pager__btn" style="margin-right: 10px; border-radius: 50px 0px 0px 50px;" title="Semana anterior"><</button>
              <span id="weekLabel" class="">—</span>
              <button id="nextWeek" class="pager__btn" style="margin-left: 10px; border-radius: 0px 50px 50px 0px;" title="Próxima semana">></button>
            </div>
            
          </div>
            
          <div class="segmented">
            <a href="/agenda-day.html" >DIA</a>
            <a href="/agenda-week.html" class="active">SEMANA</a>
          </div>
        </div>
        
        <div id="weekGrid" class="week-grid mt-12" role="grid" aria-label="Agenda semanal"></div>
      </div>
    </div>
  </div>

  <!-- Reuse your modal markup (same as day view) -->
  <div class="modal" id="apptModal" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
      <div class="modal__dialog" role="dialog" aria-modal="true">
        <div class="modal__header">
          <h2 id="apptTitle">Nova Consulta</h2>
        </div>
        <form id="apptForm" class="modal__body mt-12" autocomplete="off">
          <div class="form-grid">
            <div class="form-row">
              <label>Tipo de compromisso</label>
              <select name="appointment_type" id="f_type" required>
                <option value="PRIMEIRA_VEZ">Primeira vez</option>
                <option value="RETORNO">Retorno</option>
              </select>
            </div>
            <div class="form-row">
              <label>Data</label>
              <input type="date" name="date" id="f_date" required />
            </div>
            <div class="form-row">
              <label>Hora</label>
              <input type="time" name="time" min="08:00" max="18:00" id="f_time" required />
            </div>

            <div class="form-row col-span-2 autocomplete" style="grid-column: span 3; position:relative;">
              <label>Paciente</label>
              <input type="text" id="f_patient_search" placeholder="Digite nome do paciente" autocomplete="off" required />
              <input type="hidden" name="patient_id" id="f_patient_id" />
                <div id="acList" class="ac-list" style="display:none"></div>
            </div>

            <div class="form-row col-span-2" style="grid-column: span 2; position:relative;">
              <label>Convênio</label>
              <select name="insurance_id" id="f_insurance">
                <option value="">— particular —</option>
              </select>
            </div>

            <div class="form-row">
              <label>Valor (R$)</label>
              <input name="value_amount" id="f_value" inputmode="decimal" placeholder="400.00" />
            </div>
            <div class="form-row col-span-3" style="grid-column: span 3;">
              <label>Observações</label>
              <textarea name="notes" rows="2"></textarea>
            </div>
          </div>
          <div class="modal__footer">
            <button style="margin-left:-18px;" class="btn-primary btn-icon" type="submit" id="saveBtn"><img src="./images/SaveVector.png" alt="Salvar">Salvar</button>
            <button class="btn-secondary btn-icon" type="button" data-close><img src="./images/ExitVector.png" alt="Cancelar">Cancelar</button>
          </div>
        </form>
      </div>
  </div>

  <!-- Modal de VISUALIZAÇÃO -->
  <div class="modal" id="viewModal" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true">
      <div class="modal__header">
        <h2 id="viewTitle">Consulta</h2>
      </div>

      <div class="modal__body mt-12">
        <div id="viewContent" class="form-grid" style="font-size:14px; line-height:1.5;"></div>
      </div>

      <div class="modal__footer">
        <button id="viewEditBtn" class="btn-primary btn-icon"><img src="./images/EditWhiteVector.png" alt="Editar">Editar consulta</button>
        <button id="viewDeleteBtn" class="btn-danger btn-icon"><img src="./images/DeleteVector.png" alt="Excluir">Excluir</button>
        <button class="btn-secondary btn-icon" data-close><img src="./images/ExitVector.png" alt="Sair sem salvar">Sair sem salvar</button>
      </div>
    </div>
  </div>
  <script>
    // ========== Badge (same as before) ==========
    const todayBadge = document.getElementsByClassName('todayBadge');
    Array.from(todayBadge).map(element => {
      element.textContent = new Date().toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    });

    // ====== Elements ======
    const grid = document.getElementById('weekGrid');
    const weekLabel = document.getElementById('weekLabel');
    const prevWeek = document.getElementById('prevWeek');
    const nextWeek = document.getElementById('nextWeek');
    const todayWeek = document.getElementById('todayWeek');
    const asideEl = document.getElementById('asideList');

    const modal = document.getElementById('apptModal');
    const apptForm = document.getElementById('apptForm');
    const apptTitle = document.getElementById('apptTitle');
    const openBtn = document.getElementById('openModalBtn');

    const fDate = document.getElementById('f_date');
    const fTime = document.getElementById('f_time');
    const fType = document.getElementById('f_type');
    const fIns = document.getElementById('f_insurance');
    const fValue = document.getElementById('f_value');
    const fPatientSearch = document.getElementById('f_patient_search');
    const fPatientId = document.getElementById('f_patient_id');
    const acList = document.getElementById('acList');

    // State
    let editingId = null;
    let selectedAppt = null;

    // anchor = start of week Monday
    function startOfWeek(d){
      const x = new Date(d);
      const day = (x.getDay() + 6) % 7; // Monday = 0
      x.setDate(x.getDate() - day);
      x.setHours(0,0,0,0);
      return x;
    }
    const urlStart = new URLSearchParams(location.search).get('start');
    let anchor = urlStart ? new Date(urlStart) : new Date();
    anchor = startOfWeek(anchor);

    // time grid config
    const startHour = 8;
    const endHour = 18; // exclusive end
    const slotMinutes = 30; // each row = 30min
    const slotHeight = 40; // px per slot (matches CSS)
    const slotsPerHour = 60 / slotMinutes;
    const totalSlots = (endHour - startHour) * slotsPerHour;

    // helpers
    const ymd = d => d.toISOString().slice(0,10);
    const pad = n => String(n).padStart(2,'0');
    function fmtRange(a,b){
      const left  = a.toLocaleDateString('pt-BR', { day:'2-digit', month:'short' });
      const right = b.toLocaleDateString('pt-BR', { day:'2-digit', month:'short', year:'numeric' });
      return `${left} — ${right}`;
    }
    function tHHMM(s){
      try{ return new Date(s).toTimeString().slice(0,5); } catch(e){ return s; }
    }

    // build the static grid: left times column + 7 day columns
    function buildWeekGrid(weekStart){
      const frag = [];
      // left column (times)
      frag.push(`<div class="time-column" aria-hidden="true">
        <div class="day-head" style="height:40px;"></div>`); // empty header
      for(let i=0;i<totalSlots;i++){
        const minutes = startHour*60 + i*slotMinutes;
        const h = Math.floor(minutes/60);
        const m = minutes % 60;
        const label = `${pad(h)}:${pad(m)}`;
        frag.push(`<div class="time-slot">${label}</div>`);
      }
      frag.push(`</div>`);

      // 7 day columns
      for(let i=0;i<7;i++){
        const d = new Date(weekStart); d.setDate(d.getDate()+i);
        const label = d.toLocaleDateString('pt-BR', { weekday:'short', day:'2-digit' });
        frag.push(`<div class="day-col" data-date="${ymd(d)}">
          <div class="day-head"><span>${label}</span><span></span></div>
          <!-- slots area (empty) --></div>`);
      }
      grid.innerHTML = frag.join('');
      // set grid height to fit slots (plus header)
      grid.style.height = `${(totalSlots * slotHeight) + 40}px`;
    }

    // place appointments absolute inside the day-col
    // appts: array with starts_at (ISO) and duration_minutes
    function renderAppointments(appts){
      // clear items first
      document.querySelectorAll('.day-col').forEach(col=>{
        // remove existing appt nodes
        const existing = Array.from(col.querySelectorAll('.appt'));
        existing.forEach(n=>n.remove());
      });

      // map by date
      const groups = {};
      (appts||[]).forEach(a=>{
        const dateKey = ymd(new Date(a.starts_at));
        (groups[dateKey] ||= []).push(a);
      });

      // render per day
      Object.keys(groups).forEach(dateKey=>{
        const col = grid.querySelector(`.day-col[data-date="${dateKey}"]`);
        if (!col) return;
        const items = groups[dateKey].sort((x,y)=> (x.starts_at || x.time || '').localeCompare(y.starts_at || y.time || ''));
        items.forEach(a=>{
          // compute top & height
          const dt = new Date(a.starts_at);
          const minutesFromStart = (dt.getHours()*60 + dt.getMinutes()) - (startHour*60);
          if (minutesFromStart < 0) return; // out of range
          const top = (minutesFromStart / slotMinutes) * slotHeight + 40; // + header
          const duration = a.duration_minutes ? Number(a.duration_minutes) : 30;
          const height = Math.max(28, (duration / slotMinutes) * slotHeight + 5); // minimum height
          const who = a.patient_name || '—';
          const ins = a.insurance_name || 'Particular';
          // create element
          const div = document.createElement('div');
          div.className = 'appt';
          div.style.top = `${top}px`;
          div.style.height = `${height}px`;
          div.dataset.action = 'open-form';
          div.dataset.id = a.id;
          div.innerHTML = `<div class="who">${who}</div><span class="meta">${ins}</span>`;
          col.appendChild(div);
        });
      });
    }

    const renderSidebarItem = (timeText, patientName, patientId) => `
      <div class="sidebar-item" data-appt-id="${patientId}">
        <div class="sidebar-t">${timeText}</div>
        <div class="sidebar-who"><strong>${patientName}</strong></div>
      </div>
    `;

    const emptyMessage = () =>
  '<div style="color:#888;font-size:13px;">Nenhuma consulta agendada.</div>';

    function renderWeeklySidebar(weekAppointments = []) {
    asideEl.innerHTML = weekAppointments
    .sort((a, b) =>
      String(a.starts_at || a.time || '')
        .localeCompare(String(b.starts_at || b.time || ''))
    )
    .map(appt =>
      renderSidebarItem(
        appt.starts_at
          ? new Date(appt.starts_at).toTimeString().slice(0, 5)
          : (appt.time || ''),
        appt.patient_name,
        appt.id
      )
    )
    .join('') || emptyMessage();
}


    async function openViewer(id){
      const r = await fetch(`/api/appointments/${id}`);
      if(!r.ok){ alert('Consulta não encontrada'); return; }
      const a = await r.json();
      showViewer(a);
    }

    asideEl.addEventListener('click', e => {
      const item = e.target.closest('.sidebar-item');
      if (!item) return;

      const apptId = item.getAttribute('data-appt-id');
      if (apptId) openAppointmentForm(apptId);
    });

    // fetch week from backend
    async function fetchWeek(startStr){
      const r = await fetch(`/api/appointments/week?start=${encodeURIComponent(startStr)}`);
      if (!r.ok) return [];
      return r.json();
    }

    // load week: build grid + appointments
    async function loadWeek(){
      const start = startOfWeek(anchor);
      const end = new Date(start); end.setDate(end.getDate() + 6);
      weekLabel.textContent = fmtRange(start, end);
      buildWeekGrid(start);
      const data = await fetchWeek(ymd(start));
      renderAppointments(data);
      renderWeeklySidebar(data);
    }

    // navigation
    prevWeek.addEventListener('click', ()=>{ anchor.setDate(anchor.getDate()-7); loadWeek(); });
    nextWeek.addEventListener('click', ()=>{ anchor.setDate(anchor.getDate()+7); loadWeek(); });
    todayWeek.addEventListener('click', ()=>{ anchor = startOfWeek(new Date()); loadWeek(); });
    window.addEventListener('keydown', (e)=>{ if (e.key==='ArrowLeft') prevWeek.click(); if (e.key==='ArrowRight') nextWeek.click(); });

    // ========== Modal / form logic (re-using day modal behaviour) ==========
    function openModal(){ document.body.classList.add('modal-open'); modal.classList.add('is-open'); modal.setAttribute('aria-hidden','false'); setTimeout(()=>fPatientSearch.focus(),50); }
    function closeModal(){ modal.classList.remove('is-open'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); apptForm.reset(); fPatientId.value=''; acList.style.display='none'; editingId=null; apptTitle.textContent='Nova Consulta'; }
    modal.addEventListener('click', e=>{ if (e.target.matches('[data-close], .modal__backdrop')) closeModal(); });
    window.addEventListener('keydown', e=>{ if (e.key==='Escape' && modal.classList.contains('is-open')) closeModal(); });

    async function loadInsurances(){
      try{
        const r = await fetch('/api/insurances');
        if (!r.ok) return;
        const arr = await r.json();
        fIns.innerHTML = `<option value="">— particular —</option>` + arr.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
      }catch(e){ console.warn('loadInsurances', e); }
    }

    // open modal to create new appointment on specified date/time
    grid.addEventListener('dblclick', (ev)=>{
      // dblclick fallback: determine day-col clicked and nearest slot time
      const col = ev.target.closest('.day-col');
      if (!col) return;
      const rect = col.getBoundingClientRect();
      const y = ev.clientY - rect.top - 40; // subtract header height
      const slotIndex = Math.floor(y / slotHeight);
      const minutes = startHour*60 + slotIndex * slotMinutes;
      const hh = Math.floor(minutes/60), mm = minutes % 60;
      fDate.value = col.dataset.date;
      fTime.value = `${pad(hh)}:${pad(mm)}`;
      editingId = null;
      apptTitle.textContent = 'Nova Consulta';
      loadInsurances().then(openModal);
    });

    // delegation: click on appt to open edit, click on empty area to create nearby
    document.addEventListener('click', async (ev)=>{
      const btnOpen = ev.target.closest('[data-action="open-form"]');
      if (btnOpen){
        const id = btnOpen.dataset.id;
        openViewer(id);
        return;
      }
      // click on empty day column header area to open new appointment on that day
      const dayCol = ev.target.closest('.day-col');
      if (dayCol && !ev.target.closest('.appt') && !ev.target.closest('.day-head')){
        // compute clicked slot
        const rect = dayCol.getBoundingClientRect();
        const y = ev.clientY - rect.top - 40; // header
        const slotIndex = Math.floor(y / slotHeight);
        const minutes = startHour*60 + slotIndex * slotMinutes;
        const hh = Math.floor(minutes/60), mm = minutes % 60;
        fDate.value = dayCol.dataset.date;
        fTime.value = `${pad(hh)}:${pad(mm)}`;
        editingId = null;
        apptTitle.textContent = 'Nova Consulta';
        await loadInsurances();
        openModal();
        return;
      }

      const btnDelete = ev.target.closest('[data-action="delete"]');
      if (btnDelete){
        const id = btnDelete.getAttribute('data-id');
        onDelete(id);
        return;
      }
      const btnEdit = ev.target.closest('[data-action="edit"]');
      if (btnEdit){
        openEdit(btnEdit.dataset.id);
        return;
      }
    });

    // openEdit loads appointment into modal
    async function openEdit(id){
      const r = await fetch(`/api/appointments/${id}`);
      if (!r.ok){ alert('Consulta não encontrada'); return; }
      const a = await r.json();
      await loadInsurances();
      editingId = id;
      apptTitle.textContent = 'Editar Consulta';
      fDate.value = a.date || ymd(new Date(a.starts_at));
      fTime.value = a.time || tHHMM(a.starts_at);
      fPatientSearch.value = a.patient_name || '';
      fPatientId.value = a.patient_id ? String(a.patient_id) : '';
      fType.value = a.appointment_type || 'PRIMEIRA_VEZ';
      fIns.value = a.insurance_id ? String(a.insurance_id) : '';
      fValue.value = a.value_amount ?? '';
      apptForm.elements.notes.value = a.notes || '';
      openModal();
    }

    // submit form (create / update)
    apptForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const fd = new FormData(apptForm);
      const payload = Object.fromEntries(fd.entries());
      try{
        if (!payload.patient_id || payload.patient_id === ''){
          const name = (payload.patient_search || fPatientSearch.value || '').trim();
          if (!name){ alert('Informe o nome do paciente ou selecione um paciente.'); return; }
          const p = await createPatientByName(name);
          if (!p || !p.id){ alert('Erro ao criar paciente'); return; }
          payload.patient_id = p.id;
        }
        if (payload.value_amount === '') payload.value_amount = null;
        const body = {
          patient_id: payload.patient_id,
          date: payload.date,
          time: payload.time,
          appointment_type: payload.appointment_type,
          insurance_id: payload.insurance_id || null,
          notes: payload.notes || null,
          value_amount: payload.value_amount || null
        };
        const url = editingId ? `/api/appointments/${editingId}` : '/api/appointments';
        const method = editingId ? 'PUT' : 'POST';
        const r = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (!r.ok){ const txt = await r.text(); alert('Erro ao salvar: ' + txt); return; }
        closeModal();
        loadWeek();
      }catch(err){ console.error(err); alert('Erro ao salvar consulta'); }
    });

    // delete
    async function onDelete(id){
      if (!confirm('Excluir esta consulta?')) return;
      const r = await fetch(`/api/appointments/${id}`, { method:'DELETE' });
      if (!r.ok){ alert('Erro ao excluir'); return; }
      loadWeek();
    }

    // create patient by name
    async function createPatientByName(name){
      try{
        const r = await fetch('/api/patients', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ full_name: name }) });
        if (!r.ok){ const txt = await r.text(); console.warn('createPatient failed', txt); return null; }
        return await r.json();
      }catch(e){ console.error('createPatientByName', e); return null; }
    }

    // autocomplete (reuse from day)
    let acTimer = null;
    async function searchPatients(q){
      if (!q) return [];
      try{
        const r = await fetch(`/api/patients?search=${encodeURIComponent(q)}`);
        if (!r.ok) return [];
        return await r.json();
      }catch(e){ console.warn('searchPatients', e); return []; }
    }
    function renderAcList(items, query){
      acList.innerHTML = '';
      if (!items || items.length === 0){
        const div = document.createElement('div');
        div.className = 'ac-empty';
        div.textContent = `Cadastrar "${query}"`;
        div.addEventListener('click', async ()=>{ const p = await createPatientByName(query); if (p && p.id) selectPatient(p); else alert('Erro ao cadastrar paciente'); });
        acList.appendChild(div);
      } else {
        items.forEach(p=>{
          const div = document.createElement('div');
          div.className = 'ac-item';
          div.textContent = p.full_name;
          div.dataset.id = p.id;
          div.addEventListener('click', ()=> selectPatient(p));
          acList.appendChild(div);
        });
      }
      acList.style.display = 'block';
    }
    function selectPatient(p){ fPatientSearch.value = p.full_name; fPatientId.value = String(p.id); acList.style.display='none'; }

    fPatientSearch.addEventListener('input', (e)=>{ const q = e.target.value.trim(); fPatientId.value=''; if (acTimer) clearTimeout(acTimer); acTimer = setTimeout(async ()=>{ if (!q){ acList.style.display='none'; return; } const res = await searchPatients(q); renderAcList(res, q); }, 300); });
    document.addEventListener('click', (ev)=>{ if (!ev.target.closest('.autocomplete')) acList.style.display='none'; });

    // load insurances on open new
    openBtn.addEventListener('click', async ()=>{
      await loadInsurances();
      editingId = null;
      apptTitle.textContent = 'Nova Consulta';
      // default date: monday of anchor
      const d = new Date(anchor);
      fDate.value = ymd(d);
      const now = new Date(); now.setMinutes(Math.ceil(now.getMinutes()/30)*30,0,0);
      fTime.value = now.toTimeString().slice(0,5);
      fPatientSearch.value = '';
      fPatientId.value = '';
      acList.style.display='none';
      openModal();
    });

        
    function showViewer(appt){
      selectedAppt = appt;
      const d = new Date(appt.starts_at);
      const time = d.toTimeString().slice(0,5);

      viewContent.innerHTML = `
        <div class="form-row">
          <label>Tipo de compromisso</label>
          ${appt.appointment_type}
        </div>
        <div class="form-row">
          <label>Data</label>
          ${d.toLocaleDateString()}
        </div>
        <div class="form-row">
          <label>Hora</label>
          ${time}
        </div>

        <div class="form-row col-span-2 autocomplete" style="grid-column: span 3; position:relative;">
          <label>Paciente</label>
          ${appt.patient_name}
        </div>

        <div class="form-row col-span-2" style="grid-column: span 2; position:relative;">
          <label>Convênio</label>
          ${appt.insurance_name || 'Particular'}
        </div>

        <div class="form-row">
          <label>Valor (R$)</label>
          R$ ${appt.value_amount ?? '—'}
        </div>
        <div class="form-row col-span-3" style="grid-column: span 3;">
          <label>Observações</label>
          ${appt.notes || '—'}
        </div>
      `;

      document.body.classList.add('modal-open');
      viewModal.classList.add('is-open');
      viewModal.setAttribute('aria-hidden','false');
    }
    function hideViewer(){
      viewModal.classList.remove('is-open');
      viewModal.setAttribute('aria-hidden','true');
      document.body.classList.remove('modal-open');
      selectedAppt = null;
    }

    const viewModal = document.getElementById('viewModal');
    const viewContent = document.getElementById('viewContent');
    const viewEditBtn = document.getElementById('viewEditBtn');
    const viewDeleteBtn = document.getElementById('viewDeleteBtn');

    viewModal.addEventListener('click', e=>{
      if (e.target.matches('[data-close], .modal__backdrop')) hideViewer();
    });

    viewEditBtn.addEventListener('click', async () => {
      if (!selectedAppt) return;
      openEdit(selectedAppt.id);
      hideViewer();
    });

    viewDeleteBtn.addEventListener('click', () => {
      if (!selectedAppt) return;
      onDelete(selectedAppt.id);
      hideViewer();
    });

    // boot
    (async function init(){ await loadInsurances(); loadWeek(); })();

  </script>
</body>
</html>