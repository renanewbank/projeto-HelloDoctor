<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>HelloDoctor — Prontuários</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="topbar">
     <div class="logo"><img src="./images/ClipboardCheck.png" alt="">
      <h1>
        HelloDoctor
      </h1>
    </div>  
    
    <nav class="topnav">
      <a href="/agenda-day.html">Agenda</a>
      <a href="/patients.html" class="active">Prontuários</a>
      <a href="/insurances.html">Convênios</a>
      <a href="#" class="disabled" style="opacity:.4; pointer-events:none;">Outros</a>
    </nav>
     <div class="topbar__right">
        <span class="badge float todayBadge"></span>
      <div style="width:28px;height:28px;border-radius:999px;background:#e2e8f0;"></div>
    </div>
  </header>

  <div class="container" style="padding-top: 40px;">
    <h2>Prontuários</h2>

    <div class="search-bar" style="padding-top: 16px;">
      <h3>Pesquisar paciente</h3>
    <form id="searchForm" class="row" style="flex:1">
      <input style="flex:2" id="q" name="q" placeholder="Digite o nome, telefone ou CPF..." />
      <button style="display: flex; align-items: center; gap: 8px;" type="submit"><img src="./images/Vector.png" alt=""> Buscar</button>
      <button class="btn-ghost" type="button" id="clearBtn">Limpar</button>
    </form>
    </div>
    

    <div class="card">
      <div class="primary-actions">
        <div id="patientCount" class="patient-count" aria-live="polite" style="color:var(--muted)">
          0 resultados
        </div>
        <button id="openModalBtn" class="btn-primary">+ Cadastrar novo prontuário</button>
      </div>

      <table class="table mt-12">
        <thead>
          <tr>
            <th style="width:72px">#</th>
            <th>Nome</th>
            <th style="width:200px">Telefone</th>
            <th style="width:180px">CPF</th>
            <th style="width:140px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" style="color:var(--muted)"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODAL: Prontuário (criar/editar) -->
<div class="modal" id="patModal" aria-hidden="true">
  <div class="modal__backdrop" data-close></div>
  <div class="modal__dialog" role="dialog" aria-modal="true">
    <div class="modal__header">
      <h2 id="patModalTitle">Novo Prontuário</h2>
      <button class="modal__close" aria-label="Fechar" data-close>&times;</button>
    </div>
    <form id="patientForm" class="modal__body" autocomplete="off">
      <div class="section-title">Dados Pessoais</div>
      <div class="form-grid">
        <div class="form-row col-span-2">
          <label>Nome completo</label>
          <input name="full_name" required />
        </div>
        <div class="form-row">
          <label>Nome social</label>
          <input name="social_name" />
        </div>
        <div class="form-row">
          <label>Gênero</label>
          <select name="gender">
            <option value="male">Masculino</option>
            <option value="female">Feminino</option>
            <option value="other">Outros</option>
          </select>
        </div>
        <div class="form-row">
          <label>Data de nascimento</label>
          <input type="date" name="birth_date" />
        </div>
        <div class="form-row">
          <label>Profissão</label>
          <input name="profession" />
        </div>
        <div class="form-row">
          <label>Estado civil</label>
          <input name="marital_status" />
        </div>
        <div class="form-row">
          <label>Nacionalidade</label>
          <input name="nationality" />
        </div>
        <div class="form-row">
          <label>CPF</label>
          <input name="cpf" placeholder="000.000.000-00" />
        </div>
        <div class="form-row">
          <label>Convênio</label>
          <select name="insurance_id" id="insSelect">
            <option value="">— sem convênio —</option>
          </select>
        </div>
        <div class="form-row">
          <label>Nº da carteirinha</label>
          <input name="insurance_card" />
        </div>
      </div>

      <div class="section-title">Dados de Endereço</div>
      <div class="form-grid">
        <div class="form-row">
          <label>CEP</label>
          <input name="cep" />
        </div>
        <div class="form-row col-span-2">
          <label>Logradouro</label>
          <input name="address_street" />
        </div>
        <div class="form-row">
          <label>Número</label>
          <input name="address_number" />
        </div>
        <div class="form-row">
          <label>Complemento</label>
          <input name="address_comp" />
        </div>
        <div class="form-row">
          <label>Bairro</label>
          <input name="address_district" />
        </div>
        <div class="form-row">
          <label>Cidade</label>
          <input name="address_city" />
        </div>
        <div class="form-row">
          <label>Estado</label>
          <input name="address_state" />
        </div>
        <div class="form-row">
          <label>País</label>
          <input name="address_country" />
        </div>
      </div>

      <div class="section-title">Dados de Contato</div>
      <div class="form-grid">
        <div class="form-row">
          <label>E-mail</label>
          <input type="email" name="email" />
        </div>
        <div class="form-row">
          <label>Telefone celular / WhatsApp</label>
          <input name="phone_mobile" />
        </div>
        <div class="form-row">
          <label>Telefone fixo</label>
          <input name="phone_landline" />
        </div>
      </div>

      <div class="section-title">Observações</div>
      <div class="form-row">
        <textarea name="notes" rows="4" placeholder="Anotações internas"></textarea>
      </div>

      <div class="modal__footer">
        <div style="display: flex; gap: 8px; margin-left: -20px;">
          <button type="submit" class="btn-primary" id="saveBtn">Salvar prontuário</button>
          <button type="button" class="btn-secondary" data-close>Sair sem salvar</button>
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn-secondary" id="printBtn">Imprimir</button>
          <button type="button" class="btn-secondary danger" id="deleteBtn">Excluir prontuário</button>
        </div>
      </div>

    </form>
  </div>
</div>

<!-- MODAL: Visualizar Prontuário (read-only) -->
<div class="modal" id="patViewModal" aria-hidden="true">
  <div class="modal__backdrop" data-close></div>
  <div class="modal__dialog" role="dialog" aria-modal="true">
    <div class="modal__header">
      <h2 id="patViewTitle">Prontuário</h2>
      <button class="modal__close" aria-label="Fechar" data-close>&times;</button>
    </div>
    <div class="modal__body">
      <div class="section-title">Dados Pessoais</div>
      <div class="form-grid" id="pv-personal"></div>

      <div class="section-title">Convênio</div>
      <div class="form-grid" id="pv-insurance"></div>

      <div class="section-title">Endereço</div>
      <div class="form-grid" id="pv-address"></div>

      <div class="section-title">Contato</div>
      <div class="form-grid" id="pv-contact"></div>

      <div class="section-title">Observações</div>
      <div id="pv-notes" style="white-space:pre-wrap; border:1px solid var(--border); border-radius:8px; padding:10px;"></div>
    </div>
    <div class="modal__footer">
      <button type="button" class="btn-secondary" data-close>Fechar</button>
    </div>
  </div>
</div>



<script>
  const tbody = document.getElementById('tbody');
  const openModalBtn = document.getElementById('openModalBtn');
  const insSelect = document.getElementById('insSelect');

  const patModal  = document.getElementById('patModal');
  const patTitle  = document.getElementById('patModalTitle');
  const patientForm = document.getElementById('patientForm');
  const searchForm = document.getElementById('searchForm');
  const qInput     = document.getElementById('q');
  const clearBtn   = document.getElementById('clearBtn');

  // —— View modal refs
  const patViewModal = document.getElementById('patViewModal');
  const patViewTitle = document.getElementById('patViewTitle');
  const pvPersonal   = document.getElementById('pv-personal');
  const pvInsurance  = document.getElementById('pv-insurance');
  const pvAddress    = document.getElementById('pv-address');
  const pvContact    = document.getElementById('pv-contact');
  const pvNotes      = document.getElementById('pv-notes');

  function openPatView(){ 
    document.body.classList.add('modal-open');
    patViewModal.classList.add('is-open'); 
    patViewModal.setAttribute('aria-hidden','false');
  }
  function closePatView(){ 
    patViewModal.classList.remove('is-open'); 
    patViewModal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
  }

  // cria um “campo” readonly (label + valor)
  function viewField(label, value){
    return `
      <div class="form-row">
        <label>${label}</label>
        <div>${(value ?? '—')}</div>
      </div>
    `;
  }

  let editingId = null;

  // Badge
    const todayBadge = document.getElementsByClassName('todayBadge');
    
    Array.from(todayBadge).map(element => {
      element.textContent = new Date().toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    });

  function openPatModal(){
    document.body.classList.add('modal-open');
    patModal.classList.add('is-open');
    patModal.setAttribute('aria-hidden','false');
    setTimeout(()=>patientForm.full_name.focus(),0);
  }
  function closePatModal(){ 
    patModal.classList.remove('is-open');
    patModal.setAttribute('aria-hidden','true');
    patientForm.reset(); editingId=null; 
    patTitle.textContent='Novo prontuário';
    document.getElementById('saveBtn').textContent='Salvar prontuário';
    document.getElementById('deleteBtn').style.display='none';
    document.getElementById('printBtn').style.display='none';
    document.body.classList.remove('modal-open');
  }


  // Abrir para criar
  openModalBtn.addEventListener('click', async ()=>{
    await loadInsurances();
    editingId = null;
    patTitle.textContent = 'Novo Prontuário';
    document.getElementById('saveBtn').textContent = 'Salvar prontuário';
    openPatModal();
  });

  // Fechar modal
  patModal.addEventListener('click', e => {
    if (e.target.matches('[data-close], .modal__backdrop')) closePatModal();
  });
  window.addEventListener('keydown', e => {
    if (e.key==='Escape' && patModal.classList.contains('is-open')) closePatModal();
  });



  // Criar/Editar
  patientForm.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(patientForm);
    const payload = Object.fromEntries(fd.entries());

    const method = editingId ? 'PUT' : 'POST';
    const url    = editingId ? `/api/patients/${editingId}` : '/api/patients';

    const r = await fetch(url, {
      method, headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!r.ok){
      const err = await r.json().catch(()=>({error:'Erro'}));
      alert(err.error || 'Erro ao salvar');
      return;
    }
    closePatModal();
    loadList(qInput.value.trim());
  });

  // View
  patViewModal.addEventListener('click', e => {
  if (e.target.matches('[data-close], .modal__backdrop')) closePatView();
  });
  window.addEventListener('keydown', e => {
    if (e.key==='Escape' && patViewModal.classList.contains('is-open')) closePatView();
  });


  function rowTpl(p){
    return `
      <tr data-id="${p.id}">
        <td>${p.id}</td>
        <td>
          <a href="#" class="pat-view" data-id="${p.id}" style="color:#0b3a67; text-decoration:none;">
            ${p.full_name}
          </a>
        </td>
        <td>${p.phone_mobile || '—'}</td>
        <td>${p.cpf || '—'}</td>
        <td style="text-align:right">
          <div class="kebab-wrap">
            <button style="padding:0" class="kebab-btn" data-kebab="${p.id}" aria-label="Menu">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><circle cx="12" cy="6" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="18" r="2"/></svg>
            </button>
            <div class="kebab-pop" id="kebab-${p.id}">
              <button class="kebab-item" data-action="view" data-id="${p.id}">Visualizar</button>
              <button class="kebab-item" data-action="edit" data-id="${p.id}">Editar</button>
              <button class="kebab-item small" data-action="print" data-id="${p.id}">Imprimir</button>
              <button class="kebab-item danger" data-action="delete" data-id="${p.id}">Excluir</button>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  async function loadInsurances(){
    const r = await fetch('/api/insurances');
    const data = await r.json();
    insSelect.innerHTML = `<option value="">— sem convênio —</option>` +
      data.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  }

  async function loadList(q=''){
    // append a timestamp to avoid cached 304 responses and explicitly disable cache
    const base = q ? `/api/patients?q=${encodeURIComponent(q)}` : '/api/patients';
    const url = `${base}${base.includes('?') ? '&' : '?'}_=${Date.now()}`;

    let r;
    try {
      r = await fetch(url, { cache: 'no-store' });
    } catch (err) {
      console.error('Network error', err);
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Erro de rede.</td></tr>`;
      return;
    }

    if (!r.ok) {
      console.warn('Unexpected response', r.status, r.statusText);
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Nenhum prontuário encontrado.</td></tr>`;
      return;
    }

    const data = await r.json().catch(() => []);
    if (!Array.isArray(data) || data.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Nenhum prontuário encontrado.</td></tr>`;
      return;
    }
    const pc = document.getElementById('patientCount');
    if (pc) pc.textContent = `${data.length} resultados`;

    tbody.innerHTML = data.map(rowTpl).join('');
  }

  async function viewPatient(id){
    const r = await fetch('/api/patients/'+id);
    if (!r.ok){ alert('Paciente não encontrado'); return; }
    const p = await r.json();

    // título
    patViewTitle.textContent = `Prontuário #${p.id} — ${p.full_name || ''}`;

    // blocos
    pvPersonal.innerHTML = 
        viewField('Nome completo', p.full_name)
      + viewField('Nome social', p.social_name)
      + viewField('Gênero', p.gender)
      + viewField('Data de nascimento', p.birth_date ? String(p.birth_date).slice(0,10) : '—')
      + viewField('Profissão', p.profession)
      + viewField('Estado civil', p.marital_status)
      + viewField('Nacionalidade', p.nationality)
      + viewField('CPF', p.cpf);

    pvInsurance.innerHTML =
        viewField('Convênio (ID)', p.insurance_id || '—')
      + viewField('Carteirinha', p.insurance_card || '—');

    pvAddress.innerHTML =
        viewField('CEP', p.cep)
      + viewField('Logradouro', p.address_street)
      + viewField('Número', p.address_number)
      + viewField('Complemento', p.address_comp)
      + viewField('Bairro', p.address_district)
      + viewField('Cidade', p.address_city)
      + viewField('Estado', p.address_state)
      + viewField('País', p.address_country);

    pvContact.innerHTML =
        viewField('E-mail', p.email)
      + viewField('Celular/WhatsApp', p.phone_mobile)
      + viewField('Telefone fixo', p.phone_landline);

    pvNotes.textContent = p.notes || '—';

    openPatView();
  }


  // Busca
  searchForm.addEventListener('submit', (ev)=>{ ev.preventDefault(); loadList(qInput.value.trim()); });
  clearBtn.addEventListener('click', ()=>{ qInput.value=''; loadList(''); });

  // === kebab popover: toggle open/close and close on Escape ===
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-kebab]');
    const anyPop = document.querySelectorAll('.kebab-pop');
    if (btn){
      const id = btn.getAttribute('data-kebab');
      const pop = document.getElementById('kebab-'+id);
      anyPop.forEach(p => { if (p!==pop) p.classList.remove('is-open'); });
      pop.classList.toggle('is-open');
      return;
    }
    if (!e.target.closest('.kebab-wrap')) anyPop.forEach(p=>p.classList.remove('is-open'));
  });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') document.querySelectorAll('.kebab-pop.is-open').forEach(el=>el.classList.remove('is-open')); });

  // === ações do menu (editar / imprimir / excluir) ===
  document.addEventListener('click', async (e)=> {
    const item = e.target.closest('.kebab-item');
    if (!item) return;
    const action = item.getAttribute('data-action');
    const id = item.getAttribute('data-id');

    document.querySelectorAll('.kebab-pop.is-open').forEach(el=> el.classList.remove('is-open'));
    if(action==='view'){
      viewPatient(id);
      return;
    }

    if(action==='edit'){
      await loadInsurances();
      const r = await fetch('/api/patients/'+id);
      if(!r.ok){ alert('Paciente não encontrado'); return; }
      const p = await r.json();
      for (const [k,v] of Object.entries(p)){
        if (patientForm.elements[k] !== undefined){
          if (k==='birth_date' && v) patientForm.elements[k].value = String(v).slice(0,10);
          else patientForm.elements[k].value = v ?? '';
        }
      }
      editingId = id;
      patTitle.textContent = `Editar prontuário #${p.id}`;
      document.getElementById('saveBtn').textContent='Salvar alterações';
      openPatModal();
    }

    if(action==='delete'){
      if(!confirm('Excluir este prontuário?')) return;
      const r = await fetch('/api/patients/'+id, { method:'DELETE' });
      if(!r.ok){ const er = await r.json().catch(()=>({error:'Erro'})); alert(er.error||'Erro ao excluir'); return; }
      loadList(qInput.value.trim());
      return;
    }

    if(action==='print'){
      const r = await fetch('/api/patients/'+id);
      if(!r.ok){ alert('Paciente não encontrado'); return; }
      const p = await r.json();
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>Prontuário #${p.id}</title></head>
        <body style="font-family:Arial;padding:20px">
          <h2>Prontuário #${p.id}</h2>
          <p><strong>Nome:</strong> ${p.full_name}</p>
          <p><strong>CPF:</strong> ${p.cpf || '—'}</p>
          <p><strong>Telefone:</strong> ${p.phone_mobile || '—'}</p>
          <p><strong>E-mail:</strong> ${p.email || '—'}</p>
          <br/>
          <p><strong>Observações:</strong><br/>${(p.notes||'—').toString().replace(/\n/g,'<br>')}</p>
          <script>window.onload=()=>\`window.print()\`<\/script>
        </body></html>
      `);
      w.document.close();
    }
  });

  // clicar no nome abre o modal de visualização
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a.pat-view');
    if (!a) return;
    e.preventDefault();
    const id = a.getAttribute('data-id');
    viewPatient(id);
  });

  // botões dentro do modal grande (modo edição)
  document.getElementById('deleteBtn').addEventListener('click', async ()=>{
    if (!editingId) return;
    if (!confirm('Excluir este prontuário?')) return;
    const r = await fetch('/api/patients/'+editingId, { method:'DELETE' });
    if (!r.ok){ alert('Falha ao excluir'); return; }
    closePatModal();
    loadList(qInput.value.trim());
  });

  document.getElementById('printBtn').addEventListener('click', ()=>{
    if (editingId) printPatient(editingId);
  });

  // impressão simples
  async function printPatient(id){
    const r = await fetch('/api/patients/'+id);
    if (!r.ok){ alert('Paciente não encontrado'); return; }
    const p = await r.json();

    const w = window.open('', '_blank');
    w.document.write(`
      <html><head><title>Prontuário #${p.id}</title>
        <style>
          body{ font-family: Arial, sans-serif; padding:24px }
          h1{ margin:0 0 10px }
          hr{ margin:16px 0 }
          .row{ margin:6px 0 }
          .lbl{ color:#555 }
        </style>
      </head><body>
        <h2>Prontuário #${p.id}</h2>
        <div class="row"><span class="lbl">Nome: </span>${p.full_name || ''}</div>
        <div class="row"><span class="lbl">CPF: </span>${p.cpf || ''}</div>
        <div class="row"><span class="lbl">Telefone: </span>${p.phone_mobile || ''}</div>
        <div class="row"><span class="lbl">Convênio: </span>${p.insurance_id || '—'}</div>
        <hr/>
        <div class="row"><span class="lbl">Observações: </span>${(p.notes||'').replaceAll('<','&lt;')}</div>
        <script>window.print();<\/script>
      </body></html>
    `);
    w.document.close();
  }

  // Boot
  loadInsurances();
  loadList('');
</script>

</body>
</html>