<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>HelloDoctor — Prontuários</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="logo">H</div>HelloDoctor</div>
    <nav class="topnav">
      <a href="/agenda-day.html">Agenda</a>
      <a href="/patients.html" class="active">Prontuários</a>
      <a href="/insurances.html">Convênios</a>
      <a href="#" class="disabled" style="opacity:.4; pointer-events:none;">Outros</a>
    </nav>
     <div class="topbar__right">
        <span class="badge" id="todayBadge"></span>
      <div style="width:28px;height:28px;border-radius:999px;background:#e2e8f0;"></div>
    </div>
  </header>

  <div class="container">
    <h1>Prontuários</h1>

    <div class="card">
      <div class="header-actions">
        <form id="searchForm" class="row" style="flex:1">
          <input class="w-260" id="q" name="q" placeholder="Digite o nome, telefone ou CPF..." />
          <button class="btn-secondary" type="submit">Buscar</button>
          <button class="btn-ghost" type="button" id="clearBtn">Limpar</button>
        </form>
        <div class="primary-actions">
          <button id="openModalBtn" class="btn-primary">+ Cadastrar Novo Prontuário</button>
        </div>
      </div>

      <table class="table mt-12">
        <thead>
          <tr>
            <th style="width:72px">#</th>
            <th>Nome</th>
            <th style="width:200px">Telefone</th>
            <th style="width:180px">CPF</th>
            <th style="width:140px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" style="color:var(--muted)"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODAL: Prontuário (criar/editar) -->
<div class="modal" id="patModal" aria-hidden="true">
  <div class="modal__backdrop" data-close></div>
  <div class="modal__dialog" role="dialog" aria-modal="true">
    <div class="modal__header">
      <h2 id="patModalTitle">Novo Prontuário</h2>
      <button class="modal__close" aria-label="Fechar" data-close>&times;</button>
    </div>
    <form id="patientForm" class="modal__body" autocomplete="off">
      <div class="section-title">Dados Pessoais</div>
      <div class="form-grid">
        <div class="form-row col-span-2">
          <label>Nome completo</label>
          <input name="full_name" required />
        </div>
        <div class="form-row">
          <label>Nome social</label>
          <input name="social_name" />
        </div>
        <div class="form-row">
          <label>Gênero</label>
          <select name="gender">
            <option value="male">Masculino</option>
            <option value="female">Feminino</option>
            <option value="female">Outros</option>
          </select>
        </div>
        <div class="form-row">
          <label>Data de nascimento</label>
          <input type="date" name="birth_date" />
        </div>
        <div class="form-row">
          <label>Profissão</label>
          <input name="profession" />
        </div>
        <div class="form-row">
          <label>Estado civil</label>
          <input name="marital_status" />
        </div>
        <div class="form-row">
          <label>Nacionalidade</label>
          <input name="nationality" />
        </div>
        <div class="form-row">
          <label>CPF</label>
          <input name="cpf" placeholder="000.000.000-00" />
        </div>
        <div class="form-row">
          <label>Convênio</label>
          <select name="insurance_id" id="insSelect">
            <option value="">— sem convênio —</option>
          </select>
        </div>
        <div class="form-row">
          <label>Nº da carteirinha</label>
          <input name="insurance_card" />
        </div>
      </div>

      <div class="section-title">Dados de Endereço</div>
      <div class="form-grid">
        <div class="form-row">
          <label>CEP</label>
          <input name="cep" />
        </div>
        <div class="form-row col-span-2">
          <label>Logradouro</label>
          <input name="address_street" />
        </div>
        <div class="form-row">
          <label>Número</label>
          <input name="address_number" />
        </div>
        <div class="form-row">
          <label>Complemento</label>
          <input name="address_comp" />
        </div>
        <div class="form-row">
          <label>Bairro</label>
          <input name="address_district" />
        </div>
        <div class="form-row">
          <label>Estado</label>
          <input name="address_state" />
        </div>
        <div class="form-row">
          <label>País</label>
          <input name="address_country" />
        </div>
      </div>

      <div class="section-title">Dados de Contato</div>
      <div class="form-grid">
        <div class="form-row">
          <label>E-mail</label>
          <input type="email" name="email" />
        </div>
        <div class="form-row">
          <label>Telefone celular / WhatsApp</label>
          <input name="phone_mobile" />
        </div>
        <div class="form-row">
          <label>Telefone fixo</label>
          <input name="phone_landline" />
        </div>
      </div>

      <div class="section-title">Observações</div>
      <div class="form-row">
        <textarea name="notes" rows="4" placeholder="Anotações internas"></textarea>
      </div>

      <div class="modal__footer">
        <button type="submit" class="btn-primary" id="saveBtn">Salvar prontuário</button>
        <button type="button" class="btn-secondary" data-close>Sair sem salvar</button>
      </div>
    </form>
  </div>
</div>


  <script>
    const tbody = document.getElementById('tbody');
    const openModalBtn = document.getElementById('openModalBtn');
    const modal = document.getElementById('patModal');
    const createForm = document.getElementById('createForm');
    const searchForm = document.getElementById('searchForm');
    const qInput = document.getElementById('q');
    const clearBtn = document.getElementById('clearBtn');
    const insSelect = document.getElementById('insSelect');

    const patModal = document.getElementById('patModal');
    const patTitle = document.getElementById('patModalTitle');
    const patientForm = document.getElementById('patientForm');
    let editingId = null;

    function openPatModal(){ 
        document.body.classList.add('modal-open');
        patModal.classList.add('is-open'); 
        patModal.setAttribute('aria-hidden','false'); 
        setTimeout(()=>patientForm.full_name.focus(),0); 
    }
    function closePatModal(){ 
        patModal.classList.remove('is-open'); 
        patModal.setAttribute('aria-hidden','true'); 
        patientForm.reset(); editingId=null; 
        patTitle.textContent='Novo prontuário';
        document.getElementById('saveBtn').textContent='Salvar prontuário'; 
        document.body.classList.remove('modal-open');
    }

    // abrir para criar
    openModalBtn.addEventListener('click', async ()=>{
        await loadInsurances();
        editingId = null;
        patTitle.textContent = 'Novo prontuário';
        document.getElementById('saveBtn').textContent='Salvar prontuário';
        openPatModal();
    });

    // fechar modal
    patModal.addEventListener('click', e => { 
        if (e.target.matches('[data-close], .modal__backdrop')) closePatModal(); 
    });
    window.addEventListener('keydown', e => {
        if (e.key==='Escape' && patModal.classList.contains('is-open')) closePatModal();
    });

    // Delegação para Editar
    document.addEventListener('click', async (ev)=>{
        const btn = ev.target.closest('.edit-btn');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        await loadInsurances(); // garante convênios no select

        const r = await fetch('/api/patients/'+id);
        if (!r.ok){ alert('Paciente não encontrado'); return; }
        const p = await r.json();

        // preencher campos
        for (const [k,v] of Object.entries(p)){
            if (patientForm.elements[k] !== undefined){
            if (k === 'birth_date' && v) {
                // backend devolve 'YYYY-MM-DDTHH:MM:SSZ' ou 'YYYY-MM-DD' — normaliza para date
                patientForm.elements[k].value = String(v).slice(0,10);
            } else {
                patientForm.elements[k].value = v ?? '';
            }
            }
    }

    editingId = id;
    patTitle.textContent = `Editar prontuário #${p.id}`;
    document.getElementById('saveBtn').textContent='Salvar alterações';
    openPatModal();
    });

    // submit criar/editar
    patientForm.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const fd = new FormData(patientForm);
        const payload = Object.fromEntries(fd.entries());

        // strings vazias -> null tratadas no backend (n())
        const method = editingId ? 'PUT' : 'POST';
        const url    = editingId ? `/api/patients/${editingId}` : '/api/patients';

        const r = await fetch(url, {
            method, headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
    });
    if (!r.ok){
        const err = await r.json().catch(()=>({error:'Erro'}));
        alert(err.error || 'Erro ao salvar');
        return;
    }

    closePatModal();
    loadList(qInput.value.trim());
    });



    function rowTpl(p){
  return `
    <tr data-id="${p.id}">
      <td>${p.id}</td>
      <td>${p.full_name}</td>
      <td>${p.phone_mobile || '—'}</td>
      <td>${p.cpf || '—'}</td>
      <td style="text-align:right">
        <button class="icon-btn edit-btn" data-id="${p.id}" title="Editar">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"></path>
          </svg>
        </button>
      </td>
    </tr>
  `;
}


    async function loadInsurances(){
      const r = await fetch('/api/insurances');
      const data = await r.json();
      insSelect.innerHTML = `<option value="">— sem convênio —</option>` +
        data.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
    }

    async function loadList(q=''){
      const url = q ? `/api/patients?q=${encodeURIComponent(q)}` : '/api/patients';
      const r = await fetch(url);
      const data = await r.json();
      if (!Array.isArray(data) || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Nenhum prontuário encontrado.</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map(rowTpl).join('');
    }

    // Modal helpers
    function openModal(){ modal.classList.add('is-open'); modal.setAttribute('aria-hidden','false'); setTimeout(()=>createForm.querySelector('input[name="full_name"]').focus(),0); }
    function closeModal(){ modal.classList.remove('is-open'); modal.setAttribute('aria-hidden','true'); createForm.reset(); }

    openModalBtn.addEventListener('click', openModal);
    modal.addEventListener('click', e => { if (e.target.matches('[data-close], .modal__backdrop')) closeModal(); });
    window.addEventListener('keydown', e => { if (e.key==='Escape' && modal.classList.contains('is-open')) closeModal(); });

    // Criar prontuário
    createForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const fd = new FormData(createForm);
      const payload = Object.fromEntries(fd.entries());
      try{
        const r = await fetch('/api/patients', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!r.ok){
          const err = await r.json().catch(()=>({error:'Erro'}));
          alert(err.error || 'Erro ao criar');
          return;
        }
        closeModal();
        loadList(qInput.value.trim());
      }catch(e){ alert('Erro de rede'); }
    });

    // Busca
    searchForm.addEventListener('submit', (ev)=>{ ev.preventDefault(); loadList(qInput.value.trim()); });
    clearBtn.addEventListener('click', ()=>{ qInput.value=''; loadList(''); });

    // boot
    loadInsurances();
    loadList('');
  </script>
</body>
</html>
