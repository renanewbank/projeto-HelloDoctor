<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>HelloDoctor — Prontuários</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="topbar">
     <div class="brand">
        <div class="logo">H</div>
        HelloDoctor
    </div>
    <nav class="topnav">
      <a href="/agenda-day.html">Agenda</a>
      <a href="/patients.html" class="active">Prontuários</a>
      <a href="/insurances.html">Convênios</a>
      <a href="#" class="disabled" style="opacity:.4; pointer-events:none;">Outros</a>
    </nav>
     <div class="topbar__right">
        <span class="badge" id="todayBadge"></span>
      <div style="width:28px;height:28px;border-radius:999px;background:#e2e8f0;"></div>
    </div>
  </header>

  <div class="container">
    <h1>Prontuários</h1>

    <div class="card">
      <div class="header-actions">
        <form id="searchForm" class="row" style="flex:1">
          <input class="w-260" id="q" name="q" placeholder="Digite o nome, telefone ou CPF..." />
          <button class="btn-secondary" type="submit">Buscar</button>
          <button class="btn-ghost" type="button" id="clearBtn">Limpar</button>
        </form>
        <div class="primary-actions">
          <button id="openModalBtn" class="btn-primary">+ Novo Prontuário</button>
        </div>
      </div>

      <table class="table mt-12">
        <thead>
          <tr>
            <th style="width:72px">#</th>
            <th>Nome</th>
            <th style="width:200px">Telefone</th>
            <th style="width:180px">CPF</th>
            <th style="width:140px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" style="color:var(--muted)"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODAL: Prontuário (criar/editar) -->
<div class="modal" id="patModal" aria-hidden="true">
  <div class="modal__backdrop" data-close></div>
  <div class="modal__dialog" role="dialog" aria-modal="true">
    <div class="modal__header">
      <h2 id="patModalTitle">Novo Prontuário</h2>
      <button class="modal__close" aria-label="Fechar" data-close>&times;</button>
    </div>
    <form id="patientForm" class="modal__body" autocomplete="off">
      <div class="section-title">Dados Pessoais</div>
      <div class="form-grid">
        <div class="form-row col-span-2">
          <label>Nome completo</label>
          <input name="full_name" required />
        </div>
        <div class="form-row">
          <label>Nome social</label>
          <input name="social_name" />
        </div>
        <div class="form-row">
          <label>Gênero</label>
          <select name="gender">
            <option value="male">Masculino</option>
            <option value="female">Feminino</option>
            <option value="other">Outros</option>
          </select>
        </div>
        <div class="form-row">
          <label>Data de nascimento</label>
          <input type="date" name="birth_date" />
        </div>
        <div class="form-row">
          <label>Profissão</label>
          <input name="profession" />
        </div>
        <div class="form-row">
          <label>Estado civil</label>
          <input name="marital_status" />
        </div>
        <div class="form-row">
          <label>Nacionalidade</label>
          <input name="nationality" />
        </div>
        <div class="form-row">
          <label>CPF</label>
          <input name="cpf" placeholder="000.000.000-00" />
        </div>
        <div class="form-row">
          <label>Convênio</label>
          <select name="insurance_id" id="insSelect">
            <option value="">— sem convênio —</option>
          </select>
        </div>
        <div class="form-row">
          <label>Nº da carteirinha</label>
          <input name="insurance_card" />
        </div>
      </div>

      <div class="section-title">Dados de Endereço</div>
      <div class="form-grid">
        <div class="form-row">
          <label>CEP</label>
          <input name="cep" />
        </div>
        <div class="form-row col-span-2">
          <label>Logradouro</label>
          <input name="address_street" />
        </div>
        <div class="form-row">
          <label>Número</label>
          <input name="address_number" />
        </div>
        <div class="form-row">
          <label>Complemento</label>
          <input name="address_comp" />
        </div>
        <div class="form-row">
          <label>Bairro</label>
          <input name="address_district" />
        </div>
        <div class="form-row">
          <label>Cidade</label>
          <input name="address_" />
        </div>
        <div class="form-row">
          <label>Estado</label>
          <input name="address_state" />
        </div>
        <div class="form-row">
          <label>País</label>
          <input name="address_country" />
        </div>
      </div>

      <div class="section-title">Dados de Contato</div>
      <div class="form-grid">
        <div class="form-row">
          <label>E-mail</label>
          <input type="email" name="email" />
        </div>
        <div class="form-row">
          <label>Telefone celular / WhatsApp</label>
          <input name="phone_mobile" />
        </div>
        <div class="form-row">
          <label>Telefone fixo</label>
          <input name="phone_landline" />
        </div>
      </div>

      <div class="section-title">Observações</div>
      <div class="form-row">
        <textarea name="notes" rows="4" placeholder="Anotações internas"></textarea>
      </div>

      <div class="modal__footer">
        <button type="submit" class="btn-primary" id="saveBtn">Salvar prontuário</button>
        <button type="button" class="btn-secondary" data-close>Sair sem salvar</button>
        <button type="button" class="btn-secondary" id="printBtn" style="margin-left:auto; display:none;">Imprimir</button>
        <button type="button" class="btn-secondary danger" id="deleteBtn" style="display:none;">Excluir prontuário</button>
      </div>

    </form>
  </div>
</div>


<script>
  const tbody = document.getElementById('tbody');
  const openModalBtn = document.getElementById('openModalBtn');
  const insSelect = document.getElementById('insSelect');

  const patModal  = document.getElementById('patModal');
  const patTitle  = document.getElementById('patModalTitle');
  const patientForm = document.getElementById('patientForm');
  const searchForm = document.getElementById('searchForm');
  const qInput     = document.getElementById('q');
  const clearBtn   = document.getElementById('clearBtn');

  let editingId = null;

  // Badge de data (placeholder)
  const today = new Date();
  todayBadge.textContent = today.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });

  function openPatModal(){
    document.body.classList.add('modal-open');
    patModal.classList.add('is-open');
    patModal.setAttribute('aria-hidden','false');
    setTimeout(()=>patientForm.full_name.focus(),0);
  }
  function closePatModal(){ 
    patModal.classList.remove('is-open');
    patModal.setAttribute('aria-hidden','true');
    patientForm.reset(); editingId=null; 
    patTitle.textContent='Novo prontuário';
    document.getElementById('saveBtn').textContent='Salvar prontuário';
    document.getElementById('deleteBtn').style.display='none';
    document.getElementById('printBtn').style.display='none';
    document.body.classList.remove('modal-open');
  }


  // Abrir para criar
  openModalBtn.addEventListener('click', async ()=>{
    await loadInsurances();
    editingId = null;
    patTitle.textContent = 'Novo Prontuário';
    document.getElementById('saveBtn').textContent = 'Salvar prontuário';
    openPatModal();
  });

  // Fechar modal
  patModal.addEventListener('click', e => {
    if (e.target.matches('[data-close], .modal__backdrop')) closePatModal();
  });
  window.addEventListener('keydown', e => {
    if (e.key==='Escape' && patModal.classList.contains('is-open')) closePatModal();
  });



  // Criar/Editar
  patientForm.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(patientForm);
    const payload = Object.fromEntries(fd.entries());

    const method = editingId ? 'PUT' : 'POST';
    const url    = editingId ? `/api/patients/${editingId}` : '/api/patients';

    const r = await fetch(url, {
      method, headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!r.ok){
      const err = await r.json().catch(()=>({error:'Erro'}));
      alert(err.error || 'Erro ao salvar');
      return;
    }
    closePatModal();
    loadList(qInput.value.trim());
  });

  function rowTpl(p){
    return `
      <tr data-id="${p.id}">
        <td>${p.id}</td>
        <td>${p.full_name}</td>
        <td>${p.phone_mobile || '—'}</td>
        <td>${p.cpf || '—'}</td>
        <td style="text-align:right">
          <div class="kebab-wrap">
            <button style="padding:0" class="kebab-btn" data-kebab="${p.id}" aria-label="Menu">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><circle cx="12" cy="6" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="18" r="2"/></svg>
            </button>
            <div class="kebab-pop" id="kebab-${p.id}">
              <button class="kebab-item" data-action="edit" data-id="${p.id}">Editar</button>
              <button class="kebab-item small" data-action="print" data-id="${p.id}">Imprimir</button>
              <button class="kebab-item danger" data-action="delete" data-id="${p.id}">Excluir</button>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  async function loadInsurances(){
    const r = await fetch('/api/insurances');
    const data = await r.json();
    insSelect.innerHTML = `<option value="">— sem convênio —</option>` +
      data.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  }

  async function loadList(q=''){
    const url = q ? `/api/patients?q=${encodeURIComponent(q)}` : '/api/patients';
    const r = await fetch(url);
    const data = await r.json();
    if (!Array.isArray(data) || data.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Nenhum prontuário encontrado.</td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(rowTpl).join('');
  }

  // Busca
  searchForm.addEventListener('submit', (ev)=>{ ev.preventDefault(); loadList(qInput.value.trim()); });
  clearBtn.addEventListener('click', ()=>{ qInput.value=''; loadList(''); });

  // === toggle abre/fecha dos menus (kebab) ===
  document.addEventListener('click', (e)=>{
    if (!e.target.closest('.menu-wrap')) {
      document.querySelectorAll('.menu-pop.is-open').forEach(el=>el.classList.remove('is-open'));
      return;
    }
    const kb = e.target.closest('[data-kebab]');
    if (kb){
      const menu = kb.parentElement.querySelector('.menu-pop');
      document.querySelectorAll('.menu-pop.is-open').forEach(el=>el!==menu && el.classList.remove('is-open'));
      menu.classList.toggle('is-open');
    }
  });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') document.querySelectorAll('.menu-pop.is-open').forEach(el=>el.classList.remove('is-open')); });

  // === ações do menu (editar / imprimir / excluir) ===
  document.addEventListener('click', async (e)=>{
    const actBtn = e.target.closest('.menu-pop [data-action]');
    if(!actBtn) return;
    const id = actBtn.getAttribute('data-id');
    const action = actBtn.getAttribute('data-action');

    if(action==='edit'){
      await loadInsurances();
      const r = await fetch('/api/patients/'+id);
      if(!r.ok){ alert('Paciente não encontrado'); return; }
      const p = await r.json();
      for (const [k,v] of Object.entries(p)){
        if (patientForm.elements[k] !== undefined){
          if (k==='birth_date' && v) patientForm.elements[k].value = String(v).slice(0,10);
          else patientForm.elements[k].value = v ?? '';
        }
      }
      editingId = id;
      patTitle.textContent = `Editar prontuário #${p.id}`;
      document.getElementById('saveBtn').textContent='Salvar alterações';
      openPatModal();
    }

    if(action==='print'){
      const r = await fetch('/api/patients/'+id);
      if(!r.ok){ alert('Paciente não encontrado'); return; }
      const p = await r.json();
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>Prontuário #${p.id}</title></head>
        <body style="font-family:Arial;padding:20px">
          <h2>Prontuário #${p.id}</h2>
          <p><strong>Nome:</strong> ${p.full_name}</p>
          <p><strong>CPF:</strong> ${p.cpf || '—'}</p>
          <p><strong>Telefone:</strong> ${p.phone_mobile || '—'}</p>
          <p><strong>E-mail:</strong> ${p.email || '—'}</p>
          <br/>
          <p><strong>Observações:</strong><br/>${(p.notes||'—').toString().replace(/\n/g,'<br>')}</p>
          <script>window.onload=()=>\`window.print()\`<\/script>
        </body></html>
      `);
      w.document.close();
    }

    if(action==='delete'){
      if(!confirm('Excluir este prontuário?')) return;
      const r = await fetch('/api/patients/'+id, { method:'DELETE' });
      if(!r.ok){ const er = await r.json().catch(()=>({error:'Erro'})); alert(er.error||'Erro ao excluir'); return; }
      loadList(qInput.value.trim());
    }
  });

  // abre/fecha popover
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-kebab]');
    const anyPop = document.querySelectorAll('.kebab-pop');
    if (btn){
      const id = btn.getAttribute('data-kebab');
      const pop = document.getElementById('kebab-'+id);
      anyPop.forEach(p => { if (p!==pop) p.classList.remove('open'); });
      pop.classList.toggle('open');
      return;
    }
    if (!e.target.closest('.kebab-wrap')) anyPop.forEach(p=>p.classList.remove('open'));
  });

  // ações do popover
  document.addEventListener('click', async (e)=>{
    const item = e.target.closest('.kebab-item');
    if (!item) return;
    const action = item.getAttribute('data-action');
    const id = item.getAttribute('data-id');

    if (action === 'edit'){
      await loadInsurances();
      const r = await fetch('/api/patients/'+id);
      if (!r.ok){ alert('Paciente não encontrado'); return; }
      const p = await r.json();

      // preenche form
      for (const [k,v] of Object.entries(p)){
        if (patientForm.elements[k] !== undefined){
          if (k==='birth_date' && v) patientForm.elements[k].value = String(v).slice(0,10);
          else patientForm.elements[k].value = v ?? '';
        }
      }

      editingId = id;
      patTitle.textContent = `Editar prontuário #${p.id}`;
      document.getElementById('saveBtn').textContent='Salvar alterações';
      // mostra botões extras em modo edição
      document.getElementById('deleteBtn').style.display = 'inline-block';
      document.getElementById('printBtn').style.display  = 'inline-block';
      openPatModal();
    }

    if (action === 'delete'){
      if (!confirm('Excluir este prontuário?')) return;
      const r = await fetch('/api/patients/'+id, { method:'DELETE' });
      if (!r.ok){ alert('Falha ao excluir'); return; }
      loadList(qInput.value.trim());
    }

    if (action === 'print'){
      printPatient(id);
    }
  });

  // botões dentro do modal grande (modo edição)
  document.getElementById('deleteBtn').addEventListener('click', async ()=>{
    if (!editingId) return;
    if (!confirm('Excluir este prontuário?')) return;
    const r = await fetch('/api/patients/'+editingId, { method:'DELETE' });
    if (!r.ok){ alert('Falha ao excluir'); return; }
    closePatModal();
    loadList(qInput.value.trim());
  });

  document.getElementById('printBtn').addEventListener('click', ()=>{
    if (editingId) printPatient(editingId);
  });

  // impressão simples
  async function printPatient(id){
    const r = await fetch('/api/patients/'+id);
    if (!r.ok){ alert('Paciente não encontrado'); return; }
    const p = await r.json();

    const w = window.open('', '_blank');
    w.document.write(`
      <html><head><title>Prontuário #${p.id}</title>
        <style>
          body{ font-family: Arial, sans-serif; padding:24px }
          h1{ margin:0 0 10px }
          hr{ margin:16px 0 }
          .row{ margin:6px 0 }
          .lbl{ color:#555 }
        </style>
      </head><body>
        <h1>Prontuário #${p.id}</h1>
        <div class="row"><span class="lbl">Nome: </span>${p.full_name || ''}</div>
        <div class="row"><span class="lbl">CPF: </span>${p.cpf || ''}</div>
        <div class="row"><span class="lbl">Telefone: </span>${p.phone_mobile || ''}</div>
        <div class="row"><span class="lbl">Convênio: </span>${p.insurance_id || '—'}</div>
        <hr/>
        <div class="row"><span class="lbl">Observações: </span>${(p.notes||'').replaceAll('<','&lt;')}</div>
        <script>window.print();<\/script>
      </body></html>
    `);
    w.document.close();
  }

  // Boot
  loadInsurances();
  loadList('');
</script>

</body>
</html>