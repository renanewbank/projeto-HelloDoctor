<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>HelloDoctor — Convênios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo"><img src="./images/ClipboardCheck.png" alt="">
      <h1>
        HelloDoctor
      </h1>
    </div>  
    <nav class="topnav">
      <a href="/agenda-day.html">Agenda</a>
      <a href="/patients.html">Prontuários</a>
      <a href="/insurances.html" class="active">Convênios</a>
      <a href="#" class="disabled" style="opacity:.4; pointer-events:none;">Outros</a>
    </nav>
    <div class="topbar__right">
      <span class="badge float" id="todayBadge"></span>
      <div style="width:28px;height:28px;border-radius:999px;background:#e2e8f0;"></div>
    </div>
  </header>

  <div class="container" style="padding-top: 40px;">
    <h2>Convênios</h2>

    <div class="card">
      <div class="header-actions">
        <button id="openModalBtn" class="btn-primary">
          + Cadastrar Novo Convênio
        </button>
      </div>

      <table class="table mt-12" id="listTable">
        <thead>
            <tr>
                <th style="width:72px">#</th>
                <th>Convênio</th>
                <th style="width:160px">Código ANS</th>
                <th style="width:180px">Data de pagamento</th>
                <th style="width:180px">Telefone</th>
                <th style="width:240px">E-mail</th>
                <th style="width:80px; text-align:right;">Ações</th>
            </tr>
        </thead>

        <tbody id="tbody">
          <tr><td colspan="5" style="color:var(--muted)"></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== MODAL: Novo Convênio ===== -->
  <div class="modal" id="insModal" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal__header">
        <h2 id="modalTitle">Novo Convênio</h2>
        <button class="modal__close" aria-label="Fechar" data-close>&times;</button>
      </div>

      <form id="createForm" class="modal__body" autocomplete="off">
        <div class="form-grid">
            <!-- NOME (full width) -->
            <div class="form-row col-span-2">
                <label>Nome</label>
                <input name="name" placeholder="Ex.: Particular" required />
            </div>

            <!-- CÓDIGO ANS + DATA DE PAGAMENTO -->
            <div class="form-row">
                <label>Código ANS</label>
                <input name="ans_code" placeholder="Ex.: 123456" />
            </div>
            <div class="form-row">
                <label>Data de Pagamento</label>
                <input name="pay_day" type="date" />
            </div>

            <!-- TELEFONE + E-MAIL -->
            <div class="form-row">
                <label>Telefone</label>
                <input name="phone" placeholder="(11) 99999-9999" />
            </div>
            <div class="form-row">
                <label>E-mail</label>
                <input name="email" type="email" placeholder="contato@exemplo.com" />
            </div>

            <!-- OBSERVAÇÕES (full width) -->
            <div class="form-row col-span-2">
                <label>Observações</label>
                <textarea name="notes" rows="1" placeholder="Anotações internas (opcional)"></textarea>
            </div>
        </div>

        <div style="margin-left: -18px;" class="modal__footer">
            <button type="submit" class="btn-primary">Salvar convênio</button>
            <button type="button" class="btn-secondary" data-close>Sair sem salvar</button>
        </div>
        </form>

    </div>
  </div>

  <script>
  // ===== elementos base =====
  const todayBadge   = document.getElementById('todayBadge');
  const tbody        = document.getElementById('tbody');
  const openModalBtn = document.getElementById('openModalBtn');
  const modal        = document.getElementById('insModal');
  const modalTitle   = document.getElementById('modalTitle');
  const createForm   = document.getElementById('createForm');

  // estado
  let editingId = null;

  // badge de data
  todayBadge.textContent = new Date().toLocaleDateString(
    'pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' }
  );

  // ===== render de linha =====
  function rowTpl(i) {
    const pay = (i.pay_day ? String(i.pay_day).padStart(2,'0') : '—');
    return `
      <tr data-id="${i.id}">
        <td>${i.id}</td>
        <td>${i.name}</td>
        <td>${i.ans_code || '—'}</td>
        <td>${pay}</td>
        <td>${i.phone || '—'}</td>
        <td>${i.email || '—'}</td>
        <td style="text-align:right;">
          <div class="kebab-wrap">
            <button style="padding:0" class="kebab-btn" data-kebab="${i.id}" aria-label="Menu">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <circle cx="12" cy="6" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="18" r="2"/>
              </svg>
            </button>
            <div class="kebab-pop" id="kebab-${i.id}">
              <button class="kebab-item" data-action="edit" data-id="${i.id}">Editar</button>
              <button class="kebab-item danger" data-action="delete" data-id="${i.id}">Excluir</button>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  // ===== listagem com suporte a busca (padrão prontuários) =====
  async function loadList(q='') {
    const url = q ? `/api/insurances?q=${encodeURIComponent(q)}` : '/api/insurances';
    try {
      const r = await fetch(url);
      const data = await r.json();
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="color:var(--muted)">Nenhum convênio encontrado.</td></tr>`;
        return;
      }
      tbody.innerHTML = data.map(rowTpl).join('');
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="7" style="color:crimson">Erro ao carregar.</td></tr>`;
      console.error(e);
    }
  }

  // ===== modal helpers =====
  function openModal(){
    document.body.classList.add('modal-open');
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden','false');
    setTimeout(()=> modal.querySelector('input[name="name"]')?.focus(), 0);
  }
  function closeModal(){
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    createForm.reset();
    editingId = null;
    modalTitle.textContent = 'Novo Convênio';
  }
  openModalBtn.addEventListener('click', openModal);
  modal.addEventListener('click', (e)=>{ if (e.target.matches('[data-close], .modal__backdrop')) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && modal.classList.contains('is-open')) closeModal(); });

  // ===== submit do modal (criar/editar) =====
  createForm.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(createForm);
    const payload = Object.fromEntries(fd.entries());

    // converte data para apenas o dia do mês (1..31) se preenchido
    if (payload.pay_day) {
      const d = new Date(payload.pay_day);
      if (isNaN(d)) { alert('Data de pagamento inválida'); return; }
      payload.pay_day = d.getDate();
    } else {
      payload.pay_day = null;
    }

    const method = editingId ? 'PUT' : 'POST';
    const url    = editingId ? `/api/insurances/${editingId}` : '/api/insurances';

    const r = await fetch(url, {
      method, headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!r.ok){
      const err = await r.json().catch(()=>({error:'Erro'}));
      alert(err.error || 'Erro ao salvar');
      return;
    }
    closeModal();
    loadList();
  });

  // ===== kebab: abrir/fechar =====
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-kebab]');
    const all = document.querySelectorAll('.kebab-pop');
    if (btn){
      const id  = btn.getAttribute('data-kebab');
      const pop = document.getElementById('kebab-'+id);
      all.forEach(p => { if (p!==pop) p.classList.remove('is-open'); });
      pop.classList.toggle('is-open');
      return;
    }
    if (!e.target.closest('.kebab-wrap')) all.forEach(p=>p.classList.remove('is-open'));
  });

  // ===== ações do kebab (editar/excluir) =====
  document.addEventListener('click', async (e)=>{
    const item = e.target.closest('.kebab-item');
    if (!item) return;

    const action = item.getAttribute('data-action');
    const id     = item.getAttribute('data-id');

    if (action === 'edit'){
      const r = await fetch('/api/insurances/'+id);
      if (!r.ok){ alert('Convênio não encontrado'); return; }
      const it = await r.json();

      createForm.elements.name.value     = it.name || '';
      createForm.elements.ans_code.value = it.ans_code || '';
      if (it.pay_day){
        const now = new Date(), m = String(now.getMonth()+1).padStart(2,'0');
        createForm.elements.pay_day.value = `${now.getFullYear()}-${m}-${String(it.pay_day).padStart(2,'0')}`;
      } else {
        createForm.elements.pay_day.value = '';
      }
      createForm.elements.phone.value = it.phone || '';
      createForm.elements.email.value = it.email || '';
      createForm.elements.notes.value = it.notes || '';

      editingId = id;
      modalTitle.textContent = 'Editar Convênio';
      openModal();
    }

    if (action === 'delete'){
      if (!confirm('Excluir este convênio?')) return;
      const r = await fetch('/api/insurances/'+id, { method:'DELETE' });
      if (!r.ok){ alert('Falha ao excluir'); return; }
      loadList();
    }
  });

  // boot
  loadList('');
</script>
</body>
</html>
