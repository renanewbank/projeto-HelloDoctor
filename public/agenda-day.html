<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>HelloDoctor — Agenda (Dia)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .layout { display:grid; grid-template-columns: 1fr 320px; gap:18px; }
    .table-min td, .table-min th { padding:10px 12px; }
    .kebab { width:34px; height:34px; display:grid; place-items:center; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .kebab:hover{ background:#f5f8ff; border-color:#cfe0ff; }
    .dropdown {
      position:absolute; min-width:160px; background:#fff; border:1px solid var(--border); border-radius:10px;
      box-shadow: var(--shadow); padding:6px; z-index:10; display:none;
    }
    .dropdown.is-open { display:block; }
    .dropdown button { width:100%; text-align:left; background:#fff; color:#0b3a67; border:0; padding:10px 12px; border-radius:8px; }
    .dropdown button:hover { background:#e6edf6; }
    .stack { position:relative; display:inline-block; }
    .chip { font-size:12px; background:#e0f2fe; color:#0b3a67; padding:2px 8px; border-radius:999px; }
    /* link do paciente */
    .plink { color:#0b3a67; font-weight:500; text-decoration:none; }
    .container { padding: 0 20px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="logo">H</div>HelloDoctor</div>
    <nav class="topnav">
      <a href="/agenda-day.html" class="active">Agenda</a>
      <a href="/patients.html">Prontuários</a>
      <a href="/insurances.html">Convênios</a>
      <a href="#" class="disabled" style="opacity:.4; pointer-events:none;">Outros</a>
    </nav>
    <div class="topbar__right">
      <span class="badge" id="todayBadge"></span>
      <div style="width:28px;height:28px;border-radius:999px;background:#e2e8f0;"></div>
    </div>
  </header>

  <div class="main-layout">
    <aside class="sidebar">
      <div class="sidebar-title">Pacientes do dia</div>
        <div id="asideList">
        </div>
    </aside>

    <div class="container" style="width: 100%; margin: 50px;">
      <h1>Agenda do Dia</h1>
      <div class="card">
        <div class="header-actions">
          <div class="segmented">
            <a href="/agenda-day.html" class="active">DIA</a>
            <a href="/agenda-week.html">SEMANA</a>
          </div>

          <div class="toolbar">
            <div class="pager">
              <button id="prevDay" class="pager__btn" title="Dia anterior"><</button>
              <span id="dayLabel" class="pager__label">—</span>
              <button id="nextDay" class="pager__btn" title="Próximo dia">></button>
            </div>
          </div>

          <div class="primary-actions">
            <button id="openModalBtn" class="btn-primary">+ Nova Consulta</button>
          </div>
        </div>


          <!-- coluna principal -->          
            <table class="table table-min mt-12">
              <thead>
                <tr>
                  <th style="width:90px">Hora</th>
                  <th>Nome do Paciente</th>
                  <th style="width:160px">Tipo</th>
                  <th style="width:140px">Valor</th>
                  <th style="width:90px; text-align:right;">Ações</th>
                </tr>
              </thead>
              <tbody id="dayTbody">
                <tr><td colspan="5" style="color:var(--muted)">Carregando…</td></tr>
              </tbody>
            </table>            

      </div>
    </div>

    <!-- MODAL: Criar/Editar Consulta -->
    <div class="modal" id="apptModal" aria-hidden="true">
      <div class="modal__backdrop" data-close></div>
      <div class="modal__dialog" role="dialog" aria-modal="true">
        <div class="modal__header">
          <h2 id="apptTitle">Nova Consulta</h2>
          <button class="modal__close" aria-label="Fechar" data-close>&times;</button>
        </div>
        <form id="apptForm" class="modal__body" autocomplete="off">
          <div class="form-grid">
            <div class="form-row">
              <label>Data</label>
              <input type="date" name="date" id="f_date" required />
            </div>
            <div class="form-row">
              <label>Hora</label>
              <input type="time" name="time" id="f_time" required />
            </div>
            <div class="form-row col-span-2">
              <label>Paciente</label>
              <select name="patient_id" id="f_patient" required></select>
            </div>
            <div class="form-row">
              <label>Tipo</label>
              <select name="appointment_type" id="f_type" required>
                <option value="PRIMEIRA_VEZ">Primeira vez</option>
                <option value="RETORNO">Retorno</option>
              </select>
            </div>
            <div class="form-row">
              <label>Convênio</label>
              <select name="insurance_id" id="f_insurance">
                <option value="">— particular —</option>
              </select>
            </div>
            <div class="form-row">
              <label>Valor (R$)</label>
              <input name="value_amount" id="f_value" inputmode="decimal" placeholder="400.00" />
            </div>
            <div class="form-row col-span-2">
              <label>Observações</label>
              <textarea name="notes" rows="2"></textarea>
            </div>
          </div>
          <div class="modal__footer">
            <button class="btn-primary" type="submit" id="saveBtn">Salvar</button>
            <button class="btn-secondary" type="button" data-close>Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- DROPDOWN TEMPLATE (reutilizado em cada linha) -->
    <div id="rowDropdownTpl" class="dropdown" role="menu" aria-hidden="true">
      <button type="button" data-action="edit">Editar</button>
      <button type="button" data-action="delete" style="color:#b91c1c">Excluir</button>
    </div>
  </div>
  <script>
  // Badge (canto direito da topbar)
  document.getElementById('todayBadge').textContent =
    new Date().toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });

  // ===== elementos da navegação por setas =====
  const dayLabel = document.getElementById('dayLabel');
  const prevDay  = document.getElementById('prevDay');
  const nextDay  = document.getElementById('nextDay');

  // ===== elementos da tabela/aside e modal =====
  const tbody   = document.getElementById('dayTbody');
  const asideEl = document.getElementById('asideList');

  const modal     = document.getElementById('apptModal');
  const apptForm  = document.getElementById('apptForm');
  const apptTitle = document.getElementById('apptTitle');
  const openBtn   = document.getElementById('openModalBtn');

  const fDate   = document.getElementById('f_date');
  const fTime   = document.getElementById('f_time');
  const fPatient= document.getElementById('f_patient');
  const fIns    = document.getElementById('f_insurance');
  const fValue  = document.getElementById('f_value');

  // ===== estado =====
  let editingId = null;
  let currentDay = new Date();
  currentDay.setHours(0,0,0,0);

  // ===== helpers =====
  const BRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
  const ymd = d => d.toISOString().slice(0,10);
  const tHHMM = s => new Date(s).toTimeString().slice(0,5);
  const tipoStr = t => t === 'RETORNO' ? 'Retorno' : 'Primeira Vez';

  function fmtLong(d){
    return d.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
  }

  // ===== modal helpers =====
  function openModal(){
    document.body.classList.add('modal-open');
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden','false');
    setTimeout(()=>fDate.focus(),0);
  }
  function closeModal(){
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    apptForm.reset();
    editingId = null;
    apptTitle.textContent = 'Nova Consulta';
  }
  modal.addEventListener('click', e => { if (e.target.matches('[data-close], .modal__backdrop')) closeModal(); });
  window.addEventListener('keydown', e => { if (e.key==='Escape' && modal.classList.contains('is-open')) closeModal(); });

  async function loadPatients(){
    const r = await fetch('/api/patients'); const arr = await r.json();
    fPatient.innerHTML = arr.map(p=>`<option value="${p.id}">${p.full_name}</option>`).join('');
  }
  async function loadInsurances(){
    const r = await fetch('/api/insurances'); const arr = await r.json();
    fIns.innerHTML = `<option value="">— particular —</option>` + arr.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
  }

  // ===== renderização =====
  function rowTpl(a){
    const valor = (a.value_amount != null) ? BRL.format(Number(a.value_amount)) : '—';
    return `
      <tr data-id="${a.id}">
        <td>${tHHMM(a.starts_at)}</td>
        <td><a class="plink" href="/patients.html" title="Abrir prontuário">${a.patient_name}</a></td>
        <td>${tipoStr(a.appointment_type)}</td>
        <td>${valor}</td>
        <td style="text-align:right">
          <span class="stack">
            <button style="padding:0" class="kebab" data-kebab="${a.id}" aria-haspopup="menu" aria-label="Ações">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><circle cx="12" cy="6" r="1.8"></circle><circle cx="12" cy="12" r="1.8"></circle><circle cx="12" cy="18" r="1.8"></circle></svg>
            </button>
          </span>
        </td>
      </tr>`;
  }

  function renderDay(data){
    if (!Array.isArray(data) || data.length===0){
      tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Nenhuma consulta neste dia.</td></tr>`;
      asideEl.innerHTML = '';
      return;
    }
    tbody.innerHTML = data.map(rowTpl).join('');
    asideEl.innerHTML = data
      .sort((a,b)=>a.starts_at.localeCompare(b.starts_at))
      .map(a=>`<div style="justify-content:space-around;padding: 8px 0 ;border-bottom:1px solid var(--border)"><div style="margin:8px 0">${tHHMM(a.starts_at)}</div><strong>${a.patient_name}</strong></div>`)
      .join('');
  }

  async function fetchDay(dateStr){
    const r = await fetch(`/api/appointments/day?date=${(dateStr)}`);
    return r.json();
  }

  async function refreshDay(){
    dayLabel.textContent = fmtLong(currentDay);
    const data = await fetchDay(ymd(currentDay));
    renderDay(data);
  }

  // ===== navegação por setas =====
  prevDay.addEventListener('click', ()=>{ currentDay.setDate(currentDay.getDate()-1); refreshDay(); });
  nextDay.addEventListener('click', ()=>{ currentDay.setDate(currentDay.getDate()+1); refreshDay(); });
  window.addEventListener('keydown', e=>{
    if (e.key === 'ArrowLeft')  prevDay.click();
    if (e.key === 'ArrowRight') nextDay.click();
  });

  // ===== Menu kebab por linha =====
  const dropdownTpl = document.getElementById('rowDropdownTpl');
  let openedMenu = null, openedId = null;

  function closeMenu(){
    if (!openedMenu) return;
    openedMenu.classList.remove('is-open');
    openedMenu.remove();
    openedMenu = null; openedId = null;
  }

  document.addEventListener('click', async (ev)=>{
    // abrir menu
    const kb = ev.target.closest('[data-kebab]');
    if (kb){
      ev.preventDefault();
      const id = kb.getAttribute('data-kebab');
      closeMenu();
      const menu = dropdownTpl.cloneNode(true);
      menu.id = ''; menu.style.top='calc(100% + 6px)'; menu.style.right='0';
      kb.parentElement.appendChild(menu);
      requestAnimationFrame(()=>menu.classList.add('is-open'));
      openedMenu = menu; openedId = id;
      return;
    }
    // ações
    if (ev.target.closest('.dropdown [data-action="edit"]')){ const id = openedId; closeMenu(); openEdit(id); return; }
    if (ev.target.closest('.dropdown [data-action="delete"]')){ const id = openedId; closeMenu(); onDelete(id); return; }
    // clique fora
    if (openedMenu && !ev.target.closest('.dropdown') && !ev.target.closest('[data-kebab]')) closeMenu();
  });

  // ===== criar / editar / excluir =====
  document.getElementById('openModalBtn').addEventListener('click', async ()=>{
    await Promise.all([loadPatients(), loadInsurances()]);
    fDate.value = ymd(currentDay);
    const now = new Date(); now.setMinutes(Math.ceil(now.getMinutes()/30)*30,0,0);
    fTime.value = now.toTimeString().slice(0,5);
    openModal();
  });

  async function openEdit(id){
    const r = await fetch(`/api/appointments/${id}`);
    if (!r.ok){ alert('Consulta não encontrada'); return; }
    const a = await r.json();
    await Promise.all([loadPatients(), loadInsurances()]);
    editingId = id;
    apptTitle.textContent = 'Editar Consulta';
    fDate.value = a.date;
    fTime.value = a.time;
    fPatient.value = String(a.patient_id);
    fIns.value = a.insurance_id ? String(a.insurance_id) : '';
    document.getElementById('f_type').value = a.appointment_type;
    fValue.value = (a.value_amount ?? '');
    apptForm.elements.notes.value = a.notes || '';
    openModal();
  }

  apptForm.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(apptForm);
    const payload = Object.fromEntries(fd.entries());
    if (payload.value_amount === '') payload.value_amount = null;

    const url = editingId ? `/api/appointments/${editingId}` : '/api/appointments';
    const method = editingId ? 'PUT' : 'POST';

    const r = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!r.ok){ alert('Erro ao salvar'); return; }
    closeModal();
    refreshDay();
  });

  async function onDelete(id){
    if (!confirm('Excluir esta consulta?')) return;
    const r = await fetch(`/api/appointments/${id}`, { method:'DELETE' });
    if (!r.ok){ alert('Erro ao excluir'); return; }
    refreshDay();
  }

  // ===== boot =====
  (async function init(){
    const urlDate = new URLSearchParams(location.search).get('date');
    if (urlDate){ const d = new Date(urlDate); if (!isNaN(d)) currentDay = d; currentDay.setHours(0,0,0,0); }
    await refreshDay();
  })();
</script>
</body>
</html>
