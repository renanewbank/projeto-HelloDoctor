<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>HelloDoctor — Agenda Diária</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">H</div>
      HelloDoctor
    </div>
    <nav class="topnav">
      <a href="/agenda-day.html" class="active">Agenda</a>
      <a href="/patients.html">Prontuários</a>
      <a href="/insurances.html">Convênios</a>
      <a href="#" class="disabled" style="opacity:.4; pointer-events:none;">Outros</a>
    </nav>
    <div class="topbar__right">
      <span class="badge" id="todayBadge"></span>
      <div style="width:28px;height:28px;border-radius:999px;background:#e2e8f0;"></div>
    </div>
  </header>

  <div class="main-layout">
        <aside class="sidebar">
      <h2 class="sidebar-title">Pacientes do dia</h2>
      <div id="sidebarList">
        <p style="color:var(--muted); font-size:14px; padding:10px;">Carregando...</p>
      </div>
    </aside>

        <div class="container-agenda">
      <div class="agenda-actions">
        <div class="date-nav">
          <button class="btn-ghost" id="prevDayBtn"><</button>
          <span id="currentDateTitle"></span>
          <button class="btn-ghost" id="nextDayBtn">></button>
        </div>
        <div class="action-group">
          <button id="openModalBtn" class="btn-primary"> + NOVA CONSULTA</button>
          <a href="/agenda-day.html" class="btn-primary">DIA</a>
          <a href="/agenda-week.html" class="btn-secondary">SEMANA</a>
        </div>
      </div>

      <div class="card mt-12">
        <h2>Agenda da Dra. Maria Ligia Pereira</h2>
        <table class="table mt-12">
          <thead>
            <tr>
              <th style="width:100px">HORA</th>
              <th>NOME DO PACIENTE</th>
              <th style="width:140px">TIPO</th>
              <th style="width:120px">VALOR</th>
              <th style="width:100px">STATUS</th>
            </tr>
          </thead>
          <tbody id="agendaBody">
            <tr><td colspan="5" style="color:var(--muted)"></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

    <div class="modal" id="appModal" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true">
      <div class="modal__header">
        <h2 id="modalTitle">Nova Consulta</h2>
        <button class="modal__close" aria-label="Fechar" data-close>&times;</button>
      </div>

      <form id="appForm" class="modal__body" autocomplete="off">
        <div class="form-grid">
                        <div class="form-row">
                <label>Tipo de compromisso</label>
                <select name="appointment_type" required>
                  <option value="Primeira_Vez">Primeira Vez</option>
                  <option value="Retorno">Retorno</option>
                  <option value="Procedimento">Procedimento</option>
                </select>
            </div>
            <div class="form-row">
                <label>Data</label>
                <input name="date" type="date" required />
            </div>
            <div class="form-row">
                <label>Horário</label>
                <input name="time" type="time" required />
            </div>

                        <div class="form-row col-span-2">
                <label>Nome do paciente</label>
                <select name="patient_id" id="patientSelect" required>
                  <option value="">— Selecione um paciente —</option>
                </select>
            </div>
            <div class="form-row">
                <label>Status</label>
                <select name="status">
                  <option value="Marcado">Marcado</option>
                  <option value="Confirmado">Confirmado</option>
                  <option value="Cancelado">Cancelado</option>
                  <option value="Atendido">Atendido</option>
                </select>
            </div>

                        <div class="form-row">
                <label>Convênio</label>
                <select name="insurance_id" id="insSelect">
                  <option value="">— Particular —</option>
                </select>
            </div>
            <div class="form-row col-span-2">
                <label>Valor da consulta</label>
                <input name="value" placeholder="R$ 0,00" />
            </div>

                        <div class="form-row col-span-3">
                <label>Observações</label>
                <textarea name="notes" rows="3"></textarea>
            </div>
        </div>

        <div class="modal__footer">
            <button type="submit" class="btn-primary" id="saveBtn">Salvar</button>
            <button type="button" class="btn-secondary" data-close>Sair sem salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/plugin/localizedFormat.js"></script>
  <script>dayjs.extend(dayjs.plugin.localizedFormat);</script>
  <script>
  const todayBadge = document.getElementById('todayBadge');
  const currentDateTitle = document.getElementById('currentDateTitle');
  const sidebarList = document.getElementById('sidebarList');
  const agendaBody = document.getElementById('agendaBody');
  const appModal = document.getElementById('appModal');
  const appForm = document.getElementById('appForm');
  const openModalBtn = document.getElementById('openModalBtn');
  const patientSelect = document.getElementById('patientSelect');
  const insSelect = document.getElementById('insSelect');

  let editingId = null;
  let currentDay = dayjs(new URLSearchParams(window.location.search).get('date'));
  if (!currentDay.isValid()) currentDay = dayjs();

  // Badge de data no header
  todayBadge.textContent = dayjs().locale('pt-br').format('dddd, DD [de] MMMM [de] YYYY');

  function formatCurrency(value) {
    return (value ? Number(value) : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  // Popula selects com pacientes e convênios
  async function loadInitialData() {
    // Pacientes
    const rP = await fetch('/api/patients');
    const dataP = await rP.json();
    patientSelect.innerHTML = `<option value="">— Selecione um paciente —</option>` +
      dataP.map(p => `<option value="${p.id}">${p.full_name} (${p.cpf || p.phone_mobile || 'Sem doc'})</option>`).join('');

    // Convênios
    const rI = await fetch('/api/insurances');
    const dataI = await rI.json();
    insSelect.innerHTML = `<option value="">— Particular —</option>` +
      dataI.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
  }

  // Gera linha da tabela principal
  function agendaRowTpl(a) {
    return `
      <tr data-id="${a.id}" class="clickable-row">
        <td>${a.time.slice(0, 5)}</td>
        <td><a href="/patients.html#${a.patient_id}" class="patient-link">${a.patient_name}</a></td>
        <td>${a.appointment_type}</td>
        <td>${formatCurrency(a.value)}</td>
        <td>${a.status}</td>
      </tr>
    `;
  }

  // Gera item da barra lateral
  function sidebarItemTpl(a) {
    return `
      <div class="sidebar-item" data-id="${a.id}">
        <span class="time">${a.time.slice(0, 5)}</span>
        <span class="name">${a.patient_name}</span>
      </div>
    `;
  }

  async function loadAgenda() {
    const dateStr = currentDay.format('YYYY-MM-DD');
    currentDateTitle.textContent = currentDay.locale('pt-br').format('dddd, DD [de] MMMM [de] YYYY');
    

    // Atualiza URL sem recarregar
    const newUrl = `${window.location.pathname}?date=${dateStr}`;
    window.history.pushState({ path: newUrl }, '', newUrl);

    try {
      const r = await fetch(`/api/appointments/day?date=${dateStr}`);
      const data = await r.json();

      // Tabela Principal
      if (!Array.isArray(data) || data.length === 0) {
        agendaBody.innerHTML = `<tr><td colspan="5" style="color:var(--muted)">Nenhuma consulta agendada.</td></tr>`;
      } else {
        agendaBody.innerHTML = data.map(agendaRowTpl).join('');
      }

      // Barra Lateral
      if (!Array.isArray(data) || data.length === 0) {
        sidebarList.innerHTML = `<p style="color:var(--muted); font-size:14px; padding:10px;">Sem pacientes agendados.</p>`;
      } else {
        sidebarList.innerHTML = data.map(sidebarItemTpl).join('');
      }
    } catch (e) {
      agendaBody.innerHTML = `<tr><td colspan="5" style="color:crimson">Erro ao carregar agenda.</td></tr>`;
      sidebarList.innerHTML = `<p style="color:crimson; font-size:14px; padding:10px;">Erro ao carregar.</p>`;
      console.error(e);
    }
  }

  // Navegação de data
  document.getElementById('prevDayBtn').addEventListener('click', () => { currentDay = currentDay.subtract(1, 'day'); loadAgenda(); });
  document.getElementById('nextDayBtn').addEventListener('click', () => { currentDay = currentDay.add(1, 'day'); loadAgenda(); });


  // ===== Modal helpers =====
  function openModal(id=null, defaultDate=null, defaultTime=null){
    loadInitialData(); // Sempre carrega dados frescos
    editingId = id;

    if (id) {
      document.getElementById('modalTitle').textContent = 'Consulta Marcada';
      document.getElementById('saveBtn').textContent = 'Salvar Alterações';
      // Lógica para buscar e preencher dados de edição (implementada em 'click' abaixo)
    } else {
      document.getElementById('modalTitle').textContent = 'Nova Consulta';
      document.getElementById('saveBtn').textContent = 'Salvar';
      appForm.reset();
      if (defaultDate) appForm.date.value = defaultDate;
      if (defaultTime) appForm.time.value = defaultTime;
    }
    document.body.classList.add('modal-open');
    appModal.classList.add('is-open');
    appModal.setAttribute('aria-hidden', 'false');
    setTimeout(() => appForm.appointment_type.focus(), 0);
  }

  function closeModal(){
    appModal.classList.remove('is-open');
    appModal.setAttribute('aria-hidden', 'true');
    appForm.reset();
    editingId = null;
    document.body.classList.remove('modal-open');
  }

  openModalBtn.addEventListener('click', () => openModal(null, currentDay.format('YYYY-MM-DD'), '09:00'));
  appModal.addEventListener('click', (e) => { if (e.target.matches('[data-close], .modal__backdrop')) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && appModal.classList.contains('is-open')) closeModal(); });

// Submit do modal (Criação/Edição)
appForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const fd = new FormData(appForm);
    const payload = Object.fromEntries(fd.entries());
    const method = editingId ? 'PUT' : 'POST';
    const url = editingId ? `/api/appointments/${editingId}` : '/api/appointments';

    try {
    const r = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    if (!r.ok) {
        const err = await r.json().catch(()=>({error:'Erro'}));
        alert(err.error || 'Erro ao salvar agendamento');
        return;
    }
    closeModal();
    loadAgenda();
    
    } catch (e) {
        alert('Erro de rede');
        console.error(e);
    }
    });

    // Clique na linha da agenda para editar
    agendaBody.addEventListener('click', async (e) => {
    const row = e.target.closest('tr.clickable-row');
    if (!row) return;

    const id = row.getAttribute('data-id');
    openModal(id);

    const r = await fetch('/api/appointments/' + id);
    if (!r.ok) { alert('Consulta não encontrada'); closeModal(); return; }
    const item = await r.json();

     // Preencher o formulário
     for (const [k, v] of Object.entries(item)) {
        if (appForm.elements[k] !== undefined) {
            appForm.elements[k].value = v ?? '';
        }
     }
    });

  // Inicialização
  loadAgenda();
  </script>

</body>
</html>